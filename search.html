<html>
<head>
<script src="js/jquery.js"></script>
<script src="js/hydrant.js"></script>
<title>消火栓マップ</title>
<meta charset="UTF-8">
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
  // calculates distances between the two points – using the ‘Haversine’ formula.
  // http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points
  function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2-lat1);  // deg2rad below
    var dLon = deg2rad(lon2-lon1); 
    var a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
      Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in km
    return d;
  }

  function deg2rad(deg) {
    return deg * (Math.PI/180)
  }

  function initialize() {
    var params=getParams();
    var pref=params["pref"];
    var city=params["city"];
    var lat=params["lat"];
    var lng=params["lng"];
    setTitle(pref, city);
    var url="data/"+pref+"/"+city+".csv";
    var paramsArray = [];
    jQuery.ajax({
      async: false,
      url: url,
      cache: false,
      dataType: 'text'
    })
    .done(function(data) {
      var params=getParams();
      var lat=params["lat"];
      var lng=params["lng"];
      var lines=data.split(/[\r\n?]/);
      var min_distance=40000;
      var min_data;
      for ( i = 1; i < lines.length; i++ ) {
        if ( lines[i]==="" ) { continue; }
        var param = lines[i].split(",");
        var distance=getDistanceFromLatLonInKm(lat,lng,param[2],param[1]);
        //FID_,MLinkX,MLinkY,title,type,bikou,date
        if ( min_distance > distance ) {
      	  min_distance=distance;
          min_data=param;
        }
      }

      calcRoute(lat,lng, min_data[2],min_data[1]);
      $("#id").text("管理番号："+min_data[3]);
      var a=min_data[6];
      $("#last_update").text("登録日："+min_data[6]);
    })
    .fail(function(XMLHttpRequest, textStatus, errorThrown) {
      alert(errorThrown.message);
      console.log(errorThrown.message);
    })
    .always(function() {
    });
  }

  function calcRoute(lat,lng, min_lat,min_lng) {
    var genzailatlng = new google.maps.LatLng(lat,lng);
    var ikisakilatlng = new google.maps.LatLng(min_lat,min_lng);
    rendererOptions = {
      draggable: true,
      preserveViewport:false
    };

    var directionsDisplay = 
      new google.maps.DirectionsRenderer(rendererOptions);
    var map;
    var zoom = 7;
    var mapTypeId = google.maps.MapTypeId.ROADMAP

    var opts = {
      zoom: zoom,
      mapTypeId: mapTypeId
    };
    map = new google.maps.Map
    (document.getElementById("map_canvas"),opts);
    directionsDisplay.setMap(map);

    google.maps.event.addListener(directionsDisplay,
      'directions_changed', function(){
    });
    var directionsService = 
    new google.maps.DirectionsService();
    var request = {
      origin: genzailatlng,
      destination: ikisakilatlng,
      travelMode: google.maps.DirectionsTravelMode.DRIVING,
      unitSystem: google.maps.DirectionsUnitSystem.METRIC,
    optimizeWaypoints: true,
    avoidHighways: false,
    avoidTolls: false
   };
   directionsService.route(request,
   function(response,status){
    if (status == google.maps.DirectionsStatus.OK){
      directionsDisplay.setDirections(response);
    }
  });
}
</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>
<body onload="initialize();">

<div id="" class="container">
<h1><a href="index.html" class="title">消火栓マップ</a></h1>
	<div class="panel panel-default">
	  <div class="panel-heading">
	    <h3 id="id" class="panel-title">管理番号：</h3>
	  </div>
	  <div class="panel-body">
	    <div id="map_canvas" style="width:100%; height:500px; margin: 10px auto;"></div>
	    <pre id="last_update">登録日：</pre>
	  </div>
	</div>
	
	
</div>

</body>
</html>